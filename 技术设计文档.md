# 档案盒(ArchiveBox) - 技术设计文档

## 1. 项目概述

### 1.1 项目名称
- 中文名：档案盒
- 英文名：ArchiveBox

### 1.2 核心功能
离线ZIP资料聚合与导出桌面程序，支持批量导入ZIP文件，提取Word/PDF/图片/视频内容，统一预览管理，并支持导出Excel表格和Word汇总文档。

### 1.3 需求范围与约束（已确认）
- 离线要求：运行时完全离线（不依赖网络服务）
- 导入规模：ZIP数量 ≤ 50；单次总容量 ≤ 500MB
- Word：每个ZIP内仅 1 个Word（docx），且格式固定（按固定标签抽取字段）
  - 仅关注字段（固定标签）：
    - 指令编号
    - 指令标题
    - 下发时间
    - 指令内容（仅用于Word汇总展示；Excel不包含该字段）
- PDF：无需OCR；仅提取“页面可见图片”（允许某页提取 0 张），不需要页码关联
  - 实现说明（当前版本）：基于 `lopdf` 解析页面内容流，优先支持 `XObject Image` 且 `Filter=DCTDecode(JPEG)` 的图片；对 `FlateDecode` 等非JPEG的图像流先跳过（不影响PDF文件本身系统打开）
  - 新增（你修正的需求）：提供“PDF页面截图”模块（整页渲染为PNG），用于提取文本/矢量图等无法从内嵌图片获得的信息；截图可预览并可导出到Word
  - 生成策略（当前版本）：导入完成后自动后台生成PDF页面截图（默认最多20页；单页渲染最长边约1200px），避免用户手动操作
- 视频：不做转码/抽帧/封面生成；仅需预览播放
  - 若预览播放失败：允许降级为“用系统默认播放器打开”
  - 预览实现说明：优先使用 WebView 的 HTML5 `<video>` 播放；为支持播放本地解压文件，启用 Tauri `assetProtocol` 并将 `$APPDATA/**` 纳入 scope；若仍因编码/容器差异导致黑屏，则使用“系统打开”兜底
- 导出Excel（主要功能1）：用户选择已导入的多个ZIP，批量导出这些ZIP的信息到同一个Excel文件（字段按本文档 5.1）
- 导出Word（主要功能2）：用户选择多个ZIP及ZIP内文件内容，批量汇总导出到同一个Word文档
  - 按ZIP分章节
  - 每个ZIP章节末尾必须有“附件清单”
  - 附件清单只列出：该ZIP的视频文件 + 该ZIP原始ZIP文件（不列图片/PDF图片）
  - （新增）PDF原文件：可在界面勾选是否随汇总包导出到 `attachments/<zipId>/`（默认勾选），不要求列入“附件清单”
  - （更新）原始ZIP文件：必须在界面单独勾选后才随汇总包导出到 `attachments/<zipId>/`（默认不勾选），且“附件清单（仅本ZIP）”仅在勾选时才列出该原始ZIP
  - 视频/原始ZIP在Word中以“附件”形式带出即可（不要求在Word内直接播放）

### 1.4 开发与运行环境
- 开发环境：macOS
- 运行环境：Windows PC
- 网络要求：完全离线运行

## 2. 技术架构

### 2.1 技术选型
**主框架：Tauri + React**

**核心技术栈：**
```
前端层: React + TypeScript + Ant Design
├── 用户界面组件
├── 状态管理
└── 文件预览组件

业务逻辑层: Rust (Tauri后端)
├── ZIP处理: zip crate
├── Word解析: 读取docx(zip+xml) + XML解析（固定标签抽取）
├── PDF处理: 解析PDF页面内容流以提取“页面可见图片”（lopdf；当前优先支持JPEG XObject Image）
├── 图片处理: image crate
├── 视频预览: WebView <video> 播放（失败降级系统默认播放器）
├── Excel生成: rust_xlsxwriter
└── Word生成: docx-rs（章节排版 + 图片嵌入 + PDF图片嵌入 + 附件清单 + 附件打包）
```

### 2.2 选型理由
1. **性能优势**：Rust处理大量文件更高效
2. **资源占用**：符合低端机适配要求
3. **离线特性**：运行时离线（构建阶段可通过CI联网拉取依赖）
4. **跨平台构建**：开发在macOS；Windows产物建议由GitHub Actions（windows runner）构建
5. **文件处理**：Rust生态有专门的文档处理库

## 3. 界面设计

### 3.1 主界面布局
```
┌─────────────────────────────────────────────────────────────────────────┐
│ 档案盒 - ArchiveBox                                            [_][□][×] │
├─────────────────────────────────────────────────────────────────────────┤
│ [导入ZIP] [导出Excel] [导出Word]                                         │
├─────────────────────┬───────────────────────────────────────────────────┤
│ ZIP列表             │ 内容预览与选择面板                                 │
│ ┌─────────────────┐ │ ┌─────────────────────────────────────────────────┐ │
│ │☑ 202512110007   │ │ │ 📁 202512110007-ZL1                            │ │
│ │  └📄 Word文档   │ │ │ ┌─────────────────────────────────────────────┐ │ │
│ │  └📷 1张图片    │ │ │ │ 📄 Word文档内容 (自动包含)                  │ │ │
│ │☑ 202512110028   │ │ │ │ 编号: EMHD202512110007-ZL1                 │ │ │
│ │  └📄 Word文档   │ │ │ │ 标题: 样本查制                             │ │ │
│ │  └📋 1个PDF     │ │ │ │ 时间: 2025-12-11 00:39:17                 │ │ │
│ │☐ 202512120418   │ │ │ │ 内容: 所发生的xxxxxxxxxxxxx发生的          │ │ │
│ │  └📄 Word文档   │ │ │ └─────────────────────────────────────────────┘ │ │
│ │  └🎬 1个视频    │ │ │ ┌─────────────────────────────────────────────┐ │ │
│ │                 │ │ │ │ 📷 图片文件                                 │ │ │
│ │                 │ │ │ │ ☑ [图片预览缩略图] ScreenShot_2025...      │ │ │
│ │                 │ │ │ └─────────────────────────────────────────────┘ │ │
│ │                 │ │ │ ┌─────────────────────────────────────────────┐ │ │
│ │                 │ │ │ │ 📋 PDF提取图片                              │ │ │
│ │                 │ │ │ │ ☑ [图片1] ☐ [图片2] ☑ [图片3]              │ │ │
│ │                 │ │ │ └─────────────────────────────────────────────┘ │ │
│ │                 │ │ │ ┌─────────────────────────────────────────────┐ │ │
│ │                 │ │ │ │ 🎬 视频文件                                 │ │ │
│ │                 │ │ │ │ ☑ [视频封面] qqer的抖音_.mp4 [▶播放]        │ │ │
│ │                 │ │ │ └─────────────────────────────────────────────┘ │ │
│ └─────────────────┘ │ └─────────────────────────────────────────────────┘ │
└─────────────────────┴───────────────────────────────────────────────────┘
```

### 3.2 界面功能说明

#### 左侧ZIP列表
- 显示导入的ZIP文件列表
- 支持多选（复选框）
- 显示每个ZIP的文件统计信息
- 显示处理状态（解析中/完成/失败）

#### 右侧内容预览面板
- **Word区域**：显示提取的结构化字段，默认全部导出
- **图片区域**：缩略图网格展示，支持单独选择
- **PDF截图区域**：显示“PDF页面截图（整页渲染）”，支持选择并导出到Word
- **PDF文件区域**：可系统打开，并可勾选是否随汇总包导出到 `attachments/<zipId>/`
- **PDF图片区域**：显示从PDF提取的“页面可见图片”，支持选择（当前优先支持JPEG的XObject Image）
- **视频区域**：显示视频文件条目，支持播放预览（失败降级系统默认播放器）和选择
- **导出章节预览（可选）**：按“ZIP章节”展示将要导出的内容结构，并在章节末尾展示“附件清单（仅本ZIP：视频+原始ZIP）”

## 4. 数据结构设计

### 4.1 核心数据模型
```typescript
interface ZipContent {
  id: string;
  name: string;
  selected: boolean;           // 左侧列表勾选状态
  status: 'processing' | 'completed' | 'failed';
  
  wordDoc?: {
    fileName: string;
    fields: WordFields;        // 提取的字段，默认全部导出
  };
  
  images: Array<{
    id: string;
    name: string;
    selected: boolean;         // 右侧面板勾选状态
    thumbnail: string;
    filePath: string;
  }>;
  
  pdfImages: Array<{
    id: string;
    selected: boolean;         // 右侧面板勾选状态
    data: string;             // base64图片数据（图片较小；也可改为filePath按需读取）
    sourceFile: string;       // 来源PDF文件名
  }>;
  
  videos: Array<{
    id: string;
    name: string;
    selected: boolean;         // 右侧面板勾选状态
    thumbnail: string;        // 视频封面
    filePath: string;
  }>;
}

interface WordFields {
  编号: string;
  标题: string;
  时间: string;
  内容: string;               // Word汇总可展示；Excel不导出该字段
}
```

## 5. 导出格式规范

### 5.1 Excel导出格式

**文件名格式：** `导出结果_YYYYMMDD_HHMMSS.xlsx`

**表格结构：**
| 序号 | 日期 | 编号 | 标题 | 类型 | 样本 | 是否有样本 | 多次任务 | 下发时间 | 任务执行 | 备注 |
|------|------|------|------|------|------|-----------|----------|----------|----------|------|
| 1 | 20251105 | EMHD202512110007-ZL1 | 样本查制 | 指令 | 否 | 否 | 否 | 2025/1/15 11:04 | 已完成 |  |
| 2 | 20251105 | EMZL202512110028-ZL1 | 清理倒灌宣传信息，反馈数据 | 指令 | 是 | 是 | 否 | 2025/1/15 18:28 | 已完成 |  |

**字段说明：**
- **序号**：自动递增
- **日期**：从ZIP文件名提取
- **编号**：Word文档中的指令编号
- **标题**：Word文档中的指令标题
- **类型**：固定值"指令"
- **样本**：根据ZIP中是否有Word之外的内容判断（有=是，无=否）
- **是否有样本**：同"样本"字段
- **多次任务**：默认"否"
- **下发时间**：Word文档中的时间字段
- **任务执行**：默认"已完成"
- **备注**：默认空

### 5.2 Word导出格式

**文件名格式：** `汇总文档_YYYYMMDD_HHMMSS.docx`
**交付形态（更新为最可控方案）：** `汇总包_YYYYMMDD_HHMMSS.zip`
- `汇总文档_YYYYMMDD_HHMMSS.docx`
- `attachments/`（目录，按ZIP分子目录存放附件，避免同名冲突且确保“每个ZIP附件不混放”）
  - `attachments/<zipId>/`（每个ZIP一个目录；仅包含：该ZIP的视频文件 + 该ZIP原始ZIP文件）

**文档结构：**
```
编号: 202512110506-ZL1
标题: 清理倒灌宣传信息，反馈数据。
下发时间: 2025-12-11 23:11:49
内容:

[这里是Word文档的具体内容]

压缩包里图片

[这里嵌入选中的图片]

附件清单（仅本ZIP）:
- 附件目录：attachments/<zipId>/（可点击打开文件夹）
- <视频文件名.mp4>（位于 attachments/<zipId>/ 下）
- <原始ZIP文件名.zip>（位于 attachments/<zipId>/ 下）

---

[下一个ZIP的内容，格式相同]
```

**组织规则：**
- 按ZIP分章节，每个ZIP一个独立章节
- 每个章节包含：Word文档内容 + 选中的图片 + 选中的PDF图片 + （章节末尾）附件清单
- 章节间用分隔线分开
- 图片直接嵌入文档
- 视频文件与原始ZIP文件不再嵌入docx，改为随“汇总包.zip”中的 `attachments/` 目录一起交付
- 附件清单只列出本ZIP的（视频 + 原始ZIP），不得出现在其他ZIP章节中
- 附件清单中的“附件目录：attachments/”提供可点击链接，默认行为为“打开文件夹”

**超链接口径（重要）**
- 超链接目标使用相对路径：`attachments/<zipId>/`
- 交互目标：打开文件夹（而非直接打开单个文件），降低跨平台播放器/解压工具差异
- 兼容性说明：应同时提供 `attachments/README.txt` 兜底说明文件链接，并在正文提供“手动进入attachments目录”的文字说明
- 打包注意：ZIP内 `attachments/` 必须以目录权限 `0755` 写入（需包含执行位），否则在macOS下点击会提示“没有权限查看其内容”

## 6. 核心功能流程

### 6.1 导入ZIP流程
1. 用户选择多个ZIP文件
2. 复制ZIP到应用数据目录（批次目录），确保后续导出不依赖原始路径
3. 扫描ZIP条目并识别文件类型（Word/PDF/图片/视频/其他）
4. 提取Word文档的结构化字段
5. 解压出用于预览的文件（视频/图片/PDF）到批次目录
6. （后续迭代）从PDF提取“页面可见图片”
7. 更新界面显示（视频不做处理，仅按需预览；失败可降级系统默认播放器打开）

### 6.2 导出Excel流程
1. 获取左侧勾选的ZIP列表
2. 提取每个ZIP的Word字段信息
3. 判断是否有样本（ZIP中除Word外是否有其他文件）
4. 按Excel格式组织数据
5. 生成Excel文件并保存

### 6.3 导出Word流程
1. 获取左侧勾选的ZIP列表
2. 获取右侧选中的具体内容（图片/PDF图片/视频）
3. 按ZIP分章节组织内容
4. 写入章节正文（Word字段与内容片段）
5. 写入章节媒体（选中的图片、选中的PDF图片）
6. 在章节末尾写入“附件清单（仅本ZIP）”，仅列出：视频文件 + 原始ZIP文件
7. 生成 `attachments/<zipId>/` 目录内容（导出所选视频文件与原始ZIP文件）
8. 在附件清单中写入“附件目录：attachments/<zipId>/”的相对路径链接（打开文件夹），并写入 `attachments/README.txt` 说明文件链接作为兜底
9. 生成 `汇总包_YYYYMMDD_HHMMSS.zip`，包含 docx 与 attachments/ 目录

**导出验收要点（已验证）**
- 解压 `汇总包_*.zip` 后，`attachments/` 目录应可直接打开（目录权限需为 `0755`）
- docx 内点击 `attachments/<zipId>/` 链接应能打开该ZIP的附件文件夹；若环境阻止外部链接，则 `attachments/README.txt` 仍应可打开并指引用户手动进入目录
- 解压后文件时间戳应为导出时间附近（非1980-01-01）
- Word汇总文档中：ZIP图片与PDF可见图片应按用户勾选状态嵌入到对应ZIP章节中
5. 生成Word文档并保存

## 7. 项目结构

```
archive-box/
├── src-tauri/              # Rust后端
│   ├── src/
│   │   ├── main.rs
│   │   ├── commands/       # Tauri命令
│   │   │   ├── zip_handler.rs
│   │   │   ├── word_parser.rs
│   │   │   ├── pdf_processor.rs
│   │   │   ├── excel_exporter.rs
│   │   │   └── word_exporter.rs
│   │   ├── models/         # 数据模型
│   │   └── utils/          # 工具函数
│   ├── Cargo.toml
│   └── tauri.conf.json
├── src/                    # React前端
│   ├── components/
│   │   ├── ZipList.tsx
│   │   ├── ContentPanel.tsx
│   │   ├── ImagePreview.tsx
│   │   ├── VideoPreview.tsx
│   │   └── ExportButtons.tsx
│   ├── services/
│   │   └── tauri-api.ts
│   ├── types/
│   │   └── index.ts
│   ├── App.tsx
│   └── main.tsx
├── public/
├── package.json
└── README.md
```

## 8. 开发计划

### 8.1 第一阶段：基础框架
- [ ] 搭建Tauri + React项目结构
- [ ] 实现基础UI布局
- [ ] 实现ZIP文件导入功能

### 8.2 第二阶段：文件处理
- [ ] 实现Word文档解析和字段提取
- [ ] 实现PDF图片提取
- [ ] 实现图片和视频预览

### 8.3 第三阶段：导出功能
- [ ] 实现Excel导出
- [ ] 实现Word导出
- [ ] 完善用户交互和错误处理

### 8.4 第四阶段：优化完善
- [ ] 性能优化
- [ ] 错误处理完善
- [ ] 用户体验优化
- [ ] 打包和部署

## 9. 技术难点与解决方案

### 9.1 Word文档字段提取
**难点**：准确定位和提取固定模板中的字段
**解决方案**：读取docx（zip+xml）中的 `word/document.xml`，按段落拼接文本后基于固定标签抽取字段
- 支持中英文冒号（: / ：）与不定空格
- Word内部可能拆分多个 `w:t` 节点，需要先归一化再匹配
- 每个ZIP仅1个docx；抽取字段为：指令编号/指令标题/下发时间/指令内容（Excel不导出“指令内容”）

### 9.2 PDF图片提取
**难点**：仅提取“页面可见图片”，而不是导出所有图片资源
**解决方案**：解析PDF页面内容流，定位实际绘制到页面的图像对象（XObject Image / Inline Image），导出为图片
- 允许某页提取0张图片
- 不需要页码关联（导出时以“PDF图片列表”形式展示与选择）

### 9.3 视频文件处理
**难点**：不同机器/编码格式下的预览兼容性
**解决方案**：优先使用WebView的 `<video>` 进行本地文件预览；失败则降级为“用系统默认播放器打开”
- 不做转码/封面生成/元信息抽取（当前范围内不需要）

### 9.4 跨平台构建
**难点**：在macOS上构建Windows可执行文件
**解决方案**：使用GitHub Actions在 `windows-latest` runner 上完成Windows产物构建与打包（推荐）
- 开发可在macOS进行
- CI构建阶段允许联网拉取依赖；应用运行时仍保持离线

### 9.5 Word“附件带出”的兼容性说明（已验证存在风险）
**结论**：将视频/原始ZIP以“附件（OLE Package）”嵌入docx，在WPS（mac）与Word（mac）上兼容性不稳定，存在“无法打开/另存为原文件/直接报错”的风险。

**最终采用的工程策略（已确认，跨平台最可控）**：
- 导出为一个ZIP包：`汇总包_*.zip = 汇总文档_*.docx + attachments/（视频/原始ZIP）`
- docx内按ZIP章节末尾输出“附件清单（仅本ZIP）”
- 附件清单提供指向 `attachments/` 的相对路径超链接，点击行为为“打开文件夹”（已验证可行）
- 同时提供 `attachments/README.txt` 的超链接与正文兜底说明（便于在部分场景下仍可通过打开说明文件引导用户操作）
- 若受Office/WPS安全策略影响导致链接不可点，用户可手动解压后进入 `attachments/` 目录打开附件

**已解决的实现问题记录**
- 问题：macOS 解压后 `attachments/` 打不开并提示“没有权限查看其内容”
  - 根因：ZIP打包时将目录条目写成了 `0644`（目录缺少执行位），macOS无法进入目录
  - 解决：打包时 `attachments/` 目录条目权限固定为 `0755`，文件条目为 `0644`
- 问题：ZIP解压后文件时间显示为 `1980-01-01`
  - 根因：ZIP条目未设置 `last_modified_time`，默认回落到1980
  - 解决：打包时为ZIP条目设置生成时的时间戳

## 10. 性能优化策略

### 10.1 内存管理
- 流式处理大文件，避免全量加载到内存
- 及时释放临时文件和缓存
- 使用懒加载策略加载预览内容

### 10.2 用户体验
- 显示处理进度条
- 支持任务取消
- 异步处理避免界面卡顿
- 错误信息友好提示

### 10.3 文件处理
- 并发处理多个ZIP文件
- 缓存解析结果避免重复处理
- 优化图片缩略图生成
